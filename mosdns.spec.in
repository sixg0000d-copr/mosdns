# Generated by go2rpm 1.3

# @SOURCE_URL@
%global goipath  github.com/IrineSistiana/mosdns
Version:         @VERSION@

%gometa

Name:            @NAME@
Release:         @RELEASE@%{?dist}
Summary:         A flexible DNS forwarder/splitter
License:         GPLv3
URL:             %{gourl}

# Source is created by:
# curl -L @SOURCE_URL@/archive/@TAG@/@NAME@-@VERSION@.tar.gz -o @NAME@-@VERSION@.tar.gz
# tar -xzf @NAME@-@VERSION@.tar.gz
# cd @NAME@-@VERSION@
# go mod vendor
# tar -czf ../vendor.tar.gz vendor
# cd ..
# rm -rf @NAME@-@VERSION@
Source0:         %{gosource}
Source1:         vendor.tar.gz

BuildRequires:   golang >= 1.16
BuildRequires:   systemd-rpm-macros
%{?systemd_requires}

%description
mosdns is a DNS server composed of plugins, Use plugins to
implement many functions including basic DNS


%prep
%if 0%{?rhel}
%forgeautosetup
%global gobuilddir %{_builddir}/%{archivename}/_build
if [[ ! -e "%{gobuilddir}/bin" ]] ; then
    install -m 0755 -vd %{gobuilddir}/bin
    export GOPATH="%{gobuilddir}"
fi
%else
%goprep
%endif
%setup -qTD -a 1


%build
export LDFLAGS="-linkmode=external -X main.version=%{version}-rpmbuild"
%gobuild -o %{gobuilddir}/bin/mosdns %{goipath}


%install
install -m 0755 -vd                              %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/mosdns     %{buildroot}%{_bindir}/mosdns
install -m 0755 -vd                              %{buildroot}%{_sysconfdir}/mosdns


%files
%license LICENSE
%doc README.md
# binary
%{_bindir}/mosdns
# config dir
%dir %{_sysconfdir}/mosdns


# Scriptlets >>
%post
if [ $1 -eq 1 ] && [ -x %{_bindir}/mosdns ]; then
    # Initial installation
    %{_bindir}/mosdns -gen %{_sysconfdir}/mosdns/config.yaml &>/dev/null || :
    %{_bindir}/mosdns -dir %{_sysconfdir}/mosdns -s install &>/dev/null || :
fi

if [ $1 -eq 2 ] && [ ! -f /etc/systemd/system/mosdns.service ]; then
    # Upgrade from old included service unit file version
    %{_bindir}/mosdns -dir %{_sysconfdir}/mosdns -s install &>/dev/null || :
fi

%systemd_post mosdns.service

%preun
%systemd_preun mosdns.service

if [ $1 -eq 0 ] && [ -x %{_bindir}/mosdns ]; then
    # Package removal, not upgrade
    %{_bindir}/mosdns -dir %{_sysconfdir}/mosdns -s uninstall &>/dev/null || :
fi


%postun
%systemd_postun_with_restart mosdns.service
# << Scriptlets


%changelog
* @DATE@ sixg0000d <sixg0000d@gmail.com> - @VERSION@-@RELEASE@
- Make package
- For more details, please see: @SOURCE_URL@/releases/tag/@TAG@
