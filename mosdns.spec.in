# Generated by go2rpm 1.3

# @SOURCE_URL@
%global goipath  github.com/IrineSistiana/mosdns
Version:         @VERSION@

%gometa

Name:            @NAME@
Release:         @RELEASE@%{?dist}
Summary:         A flexible DNS forwarder/splitter
License:         GPLv3
URL:             %{gourl}

# Source is created by:
# curl -L @SOURCE_URL@/archive/@TAG@/@NAME@-@VERSION@.tar.gz -o @NAME@-@VERSION@.tar.gz
# tar -xzf @NAME@-@VERSION@.tar.gz
# cd @NAME@-@VERSION@
# go mod vendor
# tar -czf ../vendor.tar.gz vendor
# cd ..
# rm -rf @NAME@-@VERSION@
Source0:         %{gosource}
Source1:         vendor.tar.gz
# Custom sources
Source10:        mosdns.service.in

BuildRequires:   systemd-rpm-macros
%{?systemd_requires}

%description
mosdns is a DNS server composed of plugins, Use plugins to
implement many functions including basic DNS


%prep
%if 0%{?rhel}
%forgeautosetup
%global gobuilddir %{_builddir}/%{archivename}/_build
if [[ ! -e "%{gobuilddir}/bin" ]] ; then
    install -m 0755 -vd %{gobuilddir}/bin
    export GOPATH="%{gobuilddir}"
fi
%else
%goprep
%endif
%setup -qTD -a 1


%build
# binary
export LDFLAGS="-linkmode=external -X main.version=%{version}-rpmbuild "
%gobuild -o %{gobuilddir}/bin/mosdns %{goipath}
unset LDFLAGS
# systemd
%{__sed} -e 's|@sysconfdir@|%{_sysconfdir}|g' %{S:10} > %{gobuilddir}/mosdns.service


%install
# binary
install -m 0755 -vd                              %{buildroot}%{_bindir}
install -m 0755 -vp %{gobuilddir}/bin/mosdns     %{buildroot}%{_bindir}/mosdns
# config dir
install -m 0755 -vd                              %{buildroot}%{_sysconfdir}/mosdns
# systemd
install -m 0755 -vd                              %{buildroot}%{_unitdir}
install -m 0644 -vp %{gobuilddir}/mosdns.service %{buildroot}%{_unitdir}/mosdns.service


%files
%license LICENSE
%doc README.md
# binary
%{_bindir}/mosdns
# config dir
%dir %{_sysconfdir}/mosdns
# systemd
%{_unitdir}/mosdns.service


# Scriptlets >>
%post
%systemd_post mosdns.service

if [ $1 -eq 1 ] && [ ! -f "%{_sysconfdir}/mosdns/config.yaml" ]; then
    # Package installation, not upgrade
    (%{_bindir}/mosdns -gen "%{_sysconfdir}/mosdns/config.yaml" &>/dev/null) || :
fi

%preun
%systemd_preun mosdns.service

%postun
%systemd_postun_with_restart mosdns.service
# << Scriptlets


%changelog
* @DATE@ sixg0000d <sixg0000d@gmail.com> - @VERSION@-@RELEASE@
- Make package
- For more changelogs, please see: @SOURCE_URL@/releases/tag/@TAG@
